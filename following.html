<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="配信者専用カードパック販売プラットフォーム">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Pack&Play">
  <title>フォロー中 - Pack&Play</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/images/icon-192.png">
  <link rel="apple-touch-icon" href="assets/images/icon-192.png">
  <style>
    body {
      overflow-x: hidden;
      background: #f9fafb;
      display: flex;
      min-height: 100vh;
    }

    /* サイドバー */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 260px;
      background: white;
      border-right: 1px solid #e5e7eb;
      padding: 2rem 1.5rem 1rem;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      z-index: 1000;
    }

    .sidebar-logo {
      display: block;
      text-decoration: none;
      margin-bottom: 2rem;
      transition: opacity 0.2s;
    }

    .sidebar-logo:hover {
      opacity: 0.8;
    }

    .sidebar-logo-img {
      width: 100%;
      max-width: 180px;
      height: auto;
      display: block;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
    }

    .sidebar-nav-link {
      color: #2d1b3d;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.125rem;
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .sidebar-nav-link:hover {
      background: #f3f4f6;
    }

    .sidebar-nav-link.active {
      background: #f3f4f6;
      color: #FF1B8D;
    }

    .sidebar-footer {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
    }

    .sidebar-footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .sidebar-footer-link {
      color: #6b7280;
      text-decoration: none;
      font-size: 0.8125rem;
      transition: color 0.2s;
    }

    .sidebar-footer-link:hover {
      color: #2d1b3d;
      text-decoration: underline;
    }

    .sidebar-footer-copyright {
      color: #9ca3af;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    /* メインコンテンツエリア */
    .main-wrapper {
      margin-left: 260px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .following-content {
      max-width: 680px;
      margin: 0 auto;
      padding: 2rem 1rem;
      width: 100%;
    }

    /* ヘッダー */
    .page-header {
      background: white;
      padding: 1.5rem 1rem;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: #2d1b3d;
      margin: 0;
    }

    .back-link {
      color: #6b7280;
      text-decoration: none;
      font-size: 0.9375rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
      background: #f3f4f6;
    }

    .back-link:hover {
      background: #e5e7eb;
      color: #2d1b3d;
    }

    /* ソートコントロール */
    .sort-control {
      padding: 1rem;
      background: white;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .following-count-text {
      font-size: 0.9375rem;
      color: #6b7280;
      font-weight: 600;
    }

    .sort-select {
      padding: 0.375rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      background: transparent;
      font-weight: 500;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.2s;
      color: #6b7280;
    }

    .sort-select:focus {
      outline: none;
      border-color: #9ca3af;
    }

    /* フォロー中リスト */
    .following-list {
      background: white;
    }


    .following-empty {
      text-align: center;
      padding: 4rem 2rem;
      color: #9ca3af;
      font-size: 0.875rem;
      background: white;
    }

    /* モバイルメニューボタンとオーバーレイは css/style.css で定義 */

    .sidebar.mobile-open {
      display: flex;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      body {
        display: block;
      }

      .mobile-menu-button {
        display: flex;
      }

      .sidebar {
        display: none;
      }

      .main-wrapper {
        margin-left: 0;
      }

      .following-content {
        padding: 0;
      }

      .sort-control {
        padding-left: 3.5rem;
      }

      .page-header {
        padding: 1rem;
      }

      .page-title {
        font-size: 1.25rem;
      }

      /* カードコンポーネントのモバイル対応は css/style.css で定義 */
    }
  </style>
</head>
<body>
  <!-- モバイルメニューボタン -->
  <button class="mobile-menu-button" id="mobileMenuButton" onclick="toggleMobileMenu()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
    </svg>
  </button>

  <!-- モバイルメニューオーバーレイ -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>

  <!-- サイドバー -->
  <aside class="sidebar" id="sidebar">
    <a href="profile.html" class="sidebar-logo">
      <img src="image/logo.png" alt="Pack&Play" class="sidebar-logo-img">
    </a>
    <nav class="sidebar-nav" id="sidebarNav">
      <!-- JavaScriptで動的に生成 -->
    </nav>

    <div class="sidebar-footer">
      <div class="sidebar-footer-links">
        <a href="legal/terms.html" class="sidebar-footer-link">利用規約</a>
        <a href="legal/privacy.html" class="sidebar-footer-link">プライバシー</a>
        <a href="legal/commerce.html" class="sidebar-footer-link">特商法表記</a>
        <a href="legal/scta.html" class="sidebar-footer-link">資金決済法</a>
        <a href="legal/contact.html" class="sidebar-footer-link">お問い合わせ</a>
      </div>
      <div class="sidebar-footer-copyright">
        © 2025 Pack&Play
      </div>
    </div>
  </aside>

  <!-- メインコンテンツラッパー -->
  <div class="main-wrapper">
    <main class="following-content">
      <!-- ソートコントロール -->
      <div class="sort-control">
        <span class="following-count-text"><strong id="followingCount">0</strong>人をフォロー中</span>
        <select id="sortSelect" class="sort-select" onchange="sortFollowingCreators()">
          <option value="default">デフォルト</option>
          <option value="name">名前順</option>
          <option value="live">配信中優先</option>
        </select>
      </div>

      <!-- フォロー中リスト -->
      <div class="following-list">
        <div id="followingGrid">
          <!-- JavaScriptで動的に生成 -->
        </div>
        <div id="followingEmpty" class="following-empty" style="display: none;">
          フォロー中がいません
        </div>
      </div>
    </main>
  </div>

  <script src="js/mock-data.js"></script>
  <script src="js/main.js"></script>
  <script>
    // ログインチェック
    if (!requireLogin()) {
      // ログインが必要な場合、requireLogin関数内でリダイレクトされる
    }

    // セッション情報を取得
    const session = getCurrentSession();


    // フォロー中の配信者を表示
    function renderFollowingCreators(sortBy = 'default') {
      const followingGrid = document.getElementById('followingGrid');
      const followingEmpty = document.getElementById('followingEmpty');
      const followingCount = document.getElementById('followingCount');

      const allFollowedCreators = getFollowedCreators();

      if (allFollowedCreators.length === 0) {
        followingGrid.innerHTML = '';
        followingEmpty.style.display = 'block';
        followingCount.textContent = '0';
        return;
      }

      followingEmpty.style.display = 'none';
      followingCount.textContent = allFollowedCreators.length;

      // 並び替え
      let sortedCreators = [...allFollowedCreators];
      if (sortBy === 'name') {
        sortedCreators.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
      } else if (sortBy === 'live') {
        sortedCreators.sort((a, b) => {
          if (a.isLive && !b.isLive) return -1;
          if (!a.isLive && b.isLive) return 1;
          return 0;
        });
      }

      followingGrid.innerHTML = sortedCreators.map(creator => `
        <div class="following-card" id="creator-${creator.id}">
          <a href="creator/${creator.slug}.html" class="following-card-link">
            <div class="following-avatar">
              ${creator.name.charAt(0)}
              ${creator.isLive ? '<span class="following-live-signal"></span>' : ''}
            </div>
            <div class="following-info">
              <div class="following-name">${creator.name}</div>
              <div class="following-bio">${creator.bio || ''}</div>
            </div>
          </a>
          <button class="following-button" onclick="unfollowCreator(${creator.id}, event)">
            <span>フォロー中</span>
          </button>
        </div>
      `).join('');
    }

    function sortFollowingCreators() {
      const sortBy = document.getElementById('sortSelect').value;
      renderFollowingCreators(sortBy);
    }

    // フォロー解除
    function unfollowCreator(creatorId, event) {
      event.preventDefault();
      event.stopPropagation();

      const creator = creators.find(c => c.id === creatorId);
      const creatorName = creator ? creator.name : '配信者';

      // カスタムモーダルを表示
      showUnfollowModal(creatorId, creatorName);
    }

    // フォロー解除モーダルを表示
    function showUnfollowModal(creatorId, creatorName) {
      const modal = document.getElementById('unfollowModal');
      const message = document.getElementById('unfollowModalMessage');
      const confirmButton = document.getElementById('unfollowConfirmButton');

      message.textContent = `${creatorName}のフォローを解除しますか？`;

      confirmButton.onclick = function() {
        toggleFollow(creatorId);

        // ボタンを「フォローする」に変更
        const card = document.getElementById(`creator-${creatorId}`);
        if (card) {
          const button = card.querySelector('.following-button');
          if (button) {
            button.className = 'following-button unfollow-style';
            button.innerHTML = '<span>フォローする</span>';
            button.onclick = (e) => followCreator(creatorId, e);
            button.blur(); // フォーカスを外してホバー状態を解除
          }
        }

        // フォロー中の数を更新
        const followedCreators = getFollowedCreators();
        document.getElementById('followingCount').textContent = followedCreators.length;

        closeUnfollowModal();
      };

      modal.classList.add('active');
    }

    // フォロー解除モーダルを閉じる
    function closeUnfollowModal() {
      const modal = document.getElementById('unfollowModal');
      modal.classList.remove('active');
    }

    // フォローする
    function followCreator(creatorId, event) {
      event.preventDefault();
      event.stopPropagation();

      const creator = creators.find(c => c.id === creatorId);
      const creatorName = creator ? creator.name : '配信者';

      toggleFollow(creatorId);

      // ボタンを「フォロー中」に変更
      const card = document.getElementById(`creator-${creatorId}`);
      if (card) {
        const button = card.querySelector('.following-button');
        if (button) {
          button.className = 'following-button';
          button.innerHTML = '<span>フォロー中</span>';
          button.onclick = (e) => unfollowCreator(creatorId, e);
          button.blur(); // フォーカスを外してホバー状態を解除
        }
      }

      // フォロー中の数を更新
      const followedCreators = getFollowedCreators();
      document.getElementById('followingCount').textContent = followedCreators.length;
    }

    // モバイルメニューの開閉
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const button = document.getElementById('mobileMenuButton');
      const overlay = document.getElementById('mobileMenuOverlay');

      const isOpen = sidebar.classList.contains('mobile-open');

      if (isOpen) {
        closeMobileMenu();
      } else {
        openMobileMenu();
      }
    }

    function openMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const button = document.getElementById('mobileMenuButton');
      const overlay = document.getElementById('mobileMenuOverlay');

      sidebar.classList.add('mobile-open');
      button.classList.add('active');
      overlay.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const button = document.getElementById('mobileMenuButton');
      const overlay = document.getElementById('mobileMenuOverlay');

      sidebar.classList.remove('mobile-open');
      button.classList.remove('active');
      overlay.style.display = 'none';
      document.body.style.overflow = '';
    }

    // 初期表示
    renderSidebarNav(''); // main.jsの共通関数を使用
    renderFollowingCreators();
  </script>

  <!-- フォロー解除確認モーダル -->
  <div class="confirm-modal" id="unfollowModal">
    <div class="confirm-modal-content">
      <div class="confirm-modal-title">フォロー解除の確認</div>
      <div class="confirm-modal-message" id="unfollowModalMessage"></div>
      <div class="confirm-modal-buttons">
        <button class="confirm-modal-button confirm-modal-button-cancel" onclick="closeUnfollowModal()">キャンセル</button>
        <button class="confirm-modal-button confirm-modal-button-confirm" id="unfollowConfirmButton">解除する</button>
      </div>
    </div>
  </div>
</body>
</html>
