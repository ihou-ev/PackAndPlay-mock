<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="ストリーマー専用カードパック販売プラットフォーム">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Pack&Play">
  <title>配信設定 - Pack&Play</title>
  <!-- コンポーネントベースCSS -->
  <link rel="stylesheet" href="../css/app.css">
  <link rel="stylesheet" href="../css/pages/dashboard/settings.css">
  <link rel="manifest" href="../manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="../assets/images/icon-192.png">
  <link rel="apple-touch-icon" href="../assets/images/icon-192.png">
</head>
<body>
  <!-- モバイルメニューボタン -->
  <button class="mobile-menu-button" id="mobileMenuButton" onclick="toggleMobileMenu()">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
    </svg>
  </button>

  <!-- モバイルメニューオーバーレイ -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>

  <!-- サイドバー -->
  <aside class="sidebar" id="sidebar">
    <a href="../profile.html" class="sidebar-logo">
      <img src="../image/logo.png" alt="Pack&Play" class="sidebar-logo-img">
    </a>
    <nav class="sidebar-nav" id="sidebarNav">
      <!-- JavaScriptで動的に生成 -->
    </nav>

    <!-- サイドバーフッター -->
    <div class="sidebar-footer">
      <div class="sidebar-footer-links">
        <a href="../legal/terms.html" class="sidebar-footer-link">利用規約</a>
        <a href="../legal/privacy.html" class="sidebar-footer-link">プライバシー</a>
        <a href="../legal/commerce.html" class="sidebar-footer-link">特商法表記</a>
        <a href="../legal/scta.html" class="sidebar-footer-link">資金決済法</a>
        <a href="../legal/contact.html" class="sidebar-footer-link">お問い合わせ</a>
      </div>
      <div class="sidebar-footer-copyright">
        © 2025 Pack&Play
      </div>
    </div>
  </aside>

  <!-- メインコンテンツ -->
  <div class="main-wrapper">
    <div class="settings-content">
      <!-- ヘッダー -->
      <div class="settings-header">
        <div>
          <h1 class="settings-title">配信設定</h1>
          <p class="settings-description">配信に必要な設定を管理します</p>
        </div>
      </div>

      <!-- OBSオーバーレイURL -->
      <div class="settings-section">
        <h2 class="section-title">OBSオーバーレイURL</h2>
        <p class="section-description">OBS Studioのブラウザソースに以下のURLを設定してください</p>

        <div class="url-display-card">
          <div class="url-display-header">
            <span class="url-label">オーバーレイURL</span>
            <button class="copy-url-button" onclick="copyOverlayUrl()">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
              コピー
            </button>
          </div>
          <div class="url-display-content" id="overlayUrl">
            <!-- JavaScriptで生成 -->
          </div>
        </div>

        <!-- OBS設定手順 -->
        <div class="setup-guide">
          <h3 class="setup-guide-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            OBS Studioでの設定方法
          </h3>
          <ol class="setup-steps">
            <li>OBS Studioを開き、「ソース」パネルで「+」をクリック</li>
            <li>「ブラウザ」を選択し、名前を「Pack&Play Overlay」に設定</li>
            <li>「URL」に上記のオーバーレイURLを貼り付け</li>
            <li>幅: 1920、高さ: 1080 に設定</li>
            <li>「カスタムCSS」を有効にして、背景を透明にします</li>
            <li>「OK」をクリックして完了</li>
          </ol>
          <div class="setup-note">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            配信開始前に、承認管理ページでカードの承認を確認してください
          </div>
        </div>
      </div>

      <!-- 配信プラットフォーム連携 -->
      <div class="settings-section">
        <h2 class="section-title">配信プレイヤー埋め込み</h2>
        <p class="section-description">配信URLを入力して、プレイヤーとチャットを埋め込み表示します</p>

        <form id="streamForm" class="stream-form">
          <div class="form-group">
            <label class="form-label">配信プラットフォーム</label>
            <select id="platformSelect" class="form-select" onchange="updatePlatformHelp()">
              <option value="">選択してください</option>
              <option value="youtube">YouTube Live</option>
              <option value="twitch">Twitch</option>
              <option value="twitcasting">ツイキャス</option>
              <option value="nicolive">ニコニコ生放送</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">配信URL</label>
            <input type="url" id="streamUrl" class="form-input" placeholder="例: https://www.youtube.com/watch?v=..." required>
            <p class="form-help" id="platformHelp">プラットフォームを選択してください</p>
          </div>

          <div class="form-actions">
            <button type="submit" class="save-button">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
              保存して埋め込み
            </button>
            <button type="button" class="clear-button" onclick="clearStreamSettings()">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              クリア
            </button>
          </div>
        </form>

        <!-- 埋め込みプレビュー -->
        <div id="embedPreview" class="embed-preview hidden">
          <h3 class="embed-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            埋め込みプレビュー
          </h3>

          <div class="embed-container">
            <div class="embed-player">
              <div id="playerFrame" class="embed-frame">
                <!-- iframeが動的に挿入される -->
              </div>
            </div>
            <div class="embed-chat">
              <div id="chatFrame" class="embed-frame">
                <!-- iframeが動的に挿入される -->
              </div>
            </div>
          </div>

          <div class="embed-note">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
              <strong>ニコニコ生放送の埋め込み制限について（重要）</strong>
              <ul style="margin: 0.5rem 0 0 0; padding-left: 1.25rem; line-height: 1.6;">
                <li><strong>基本条件：</strong>配信者が番組の［共有］設定で「外部プレイヤー（ブログパーツ）許可」を有効にしている場合のみ埋め込み再生可能です</li>
                <li><strong>再生されない主な原因：</strong>
                  <ul style="margin-top:0.25rem;padding-left:1rem;">
                    <li>サードパーティCookie制限（特にiOS/Safari）により、埋め込み内でログイン状態が認識されない</li>
                    <li>2025年のライブ配信サーバ移行の影響で一部の埋め込みが不安定</li>
                    <li>番組側のX-Frame-Options/CSP設定で拒否されている</li>
                  </ul>
                </li>
                <li><strong>対処方法：</strong>
                  <ul style="margin-top:0.25rem;padding-left:1rem;">
                    <li>プレイヤー下部の「<strong>ログイン補助</strong>」ボタンで別タブでニコニコにログイン後、戻って再生</li>
                    <li>それでも再生されない場合は「<strong>公式ページで開く</strong>」ボタンから視聴</li>
                  </ul>
                </li>
                <li><strong>注意：</strong>公式の埋め込みタグを改変しないこと。手書きの古いembed/パスは避けてください</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- コンポーネントベースJavaScript -->
  <script src="../js/services/storage.js"></script>
  <script src="../js/core/utils.js"></script>
  <script src="../js/components/modal.js"></script>
  <script src="../js/components/toast.js"></script>
  <script src="../js/mock-data.js"></script>
  <script src="../js/main.js"></script>
  <script src="../js/pages/dashboard/settings.js"></script>
</body>
</html>
