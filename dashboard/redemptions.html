<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="é…ä¿¡è€…å°‚ç”¨ã‚«ãƒ¼ãƒ‰ãƒ‘ãƒƒã‚¯è²©å£²ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Pack&Play">
  <title>æ‰¿èªå¾…ã¡ã‚­ãƒ¥ãƒ¼ - Pack&Play</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="manifest" href="../manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="../assets/images/icon-192.png">
  <link rel="apple-touch-icon" href="../assets/images/icon-192.png">
  <style>
    .redemption-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: border-color 0.2s;
    }

    .redemption-card:hover {
      border-color: var(--primary);
    }

    .redemption-card.approved {
      background: #d1fae5;
      border-color: var(--success);
    }

    .redemption-card.rejected {
      background: #fee2e2;
      border-color: var(--error);
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header>
    <nav class="navbar container">
      <a href="../index.html" class="logo">
        ğŸ´ Pack&Play
      </a>
      <ul class="nav-links">
        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
      </ul>
    </nav>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main>
    <section class="page-header">
      <div class="container">
        <div class="flex-between">
          <div>
            <h1 class="page-title">æ‰¿èªå¾…ã¡ã‚­ãƒ¥ãƒ¼</h1>
            <p class="page-description">è¦–è´è€…ãŒä½¿ç”¨ã—ãŸã‚«ãƒ¼ãƒ‰ã®æ‰¿èªãƒ»å´ä¸‹ã‚’è¡Œã„ã¾ã™</p>
          </div>
          <div class="flex gap-2">
            <span class="badge badge-live" style="font-size: 1rem; padding: 0.5rem 1rem;">
              <span id="pendingCount">2</span>ä»¶ã®æ‰¿èªå¾…ã¡
            </span>
          </div>
        </div>
      </div>
    </section>

    <section style="padding: 3rem 0;">
      <div class="container">
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="flex gap-2 mb-4">
          <button class="btn btn-sm btn-outline" onclick="filterRedemptions('all')">ã™ã¹ã¦</button>
          <button class="btn btn-sm btn-primary" onclick="filterRedemptions('pending')">æ‰¿èªå¾…ã¡</button>
          <button class="btn btn-sm btn-outline" onclick="filterRedemptions('approved')">æ‰¿èªæ¸ˆã¿</button>
          <button class="btn btn-sm btn-outline" onclick="filterRedemptions('rejected')">å´ä¸‹</button>
        </div>

        <!-- æ‰¿èªå¾…ã¡ãƒªã‚¹ãƒˆ -->
        <div id="redemptionsList">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>

        <div id="emptyState" class="empty-state hidden">
          <div class="empty-state-icon">âœ…</div>
          <div class="empty-state-text">æ‰¿èªå¾…ã¡ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </section>
  </main>

  <!-- å´ä¸‹ç†ç”±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="rejectModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">å´ä¸‹ç†ç”±</h2>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1rem;">ã“ã®ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ã‚’å´ä¸‹ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="form-group">
          <label class="form-label">å´ä¸‹ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="rejectReason" class="form-textarea" placeholder="å´ä¸‹ç†ç”±ã‚’å…¥åŠ›..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" data-close-modal="rejectModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" onclick="submitReject()">å´ä¸‹ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer style="background: var(--surface); border-top: 1px solid var(--border); padding: 2rem 0; margin-top: 4rem;">
    <div class="container">
      <div class="flex-between">
        <div>
          <div class="logo mb-2">ğŸ´ Pack&Play</div>
          <p style="color: var(--text-light); font-size: 0.875rem;">
            Â© 2025 Pack&Play. All rights reserved.
          </p>
        </div>
        <div class="flex gap-3">
          <a href="#" style="color: var(--text-light); text-decoration: none;">åˆ©ç”¨è¦ç´„</a>
          <a href="#" style="color: var(--text-light); text-decoration: none;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
          <a href="#" style="color: var(--text-light); text-decoration: none;">ç‰¹å•†æ³•è¡¨è¨˜</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="../js/mock-data.js"></script>
  <script src="../js/main.js"></script>
  <script>
    // é…ä¿¡è€…ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    requireCreatorRole();

    // æ‰¿èªå¾…ã¡ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ï¼‰
    let redemptions = loadFromStorage('redemptions', redeemQueue);

    let currentFilter = 'pending';
    let rejectingId = null;

    function renderRedemptions(redemptionsToRender) {
      const list = document.getElementById('redemptionsList');
      const emptyState = document.getElementById('emptyState');

      if (redemptionsToRender.length === 0) {
        list.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');

      list.innerHTML = redemptionsToRender.map(redemption => {
        const stateClass = redemption.state === 'approved' ? 'approved' : redemption.state === 'rejected' ? 'rejected' : '';
        const timeAgo = formatTimeAgo(redemption.createdAt);

        return `
          <div class="redemption-card ${stateClass} fade-in">
            <div class="flex-between mb-3">
              <div class="flex gap-2" style="align-items: center;">
                <div style="font-size: 2rem;">ğŸ´</div>
                <div>
                  <div style="font-size: 1.125rem; font-weight: 700;">${redemption.cardName}</div>
                  <div style="color: var(--text-light); font-size: 0.875rem;">
                    ${redemption.viewerName} â€¢ ${timeAgo}
                  </div>
                </div>
              </div>
              <span class="badge badge-rarity-${redemption.cardRarity.toLowerCase()}">${redemption.cardRarity}</span>
            </div>

            ${redemption.viewerMessage ? `
              <div style="background: #f9fafb; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; border-left: 4px solid var(--primary);">
                <div style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 0.25rem;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</div>
                <div>${redemption.viewerMessage}</div>
              </div>
            ` : ''}

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
              ${redemption.state === 'pending' ? `
                <button class="btn btn-success btn-sm" onclick="approveRedemption(${redemption.id})">
                  âœ… æ‰¿èª
                </button>
                <button class="btn btn-danger btn-sm" onclick="openRejectModal(${redemption.id})">
                  âŒ å´ä¸‹
                </button>
              ` : `
                <span class="status status-${redemption.state}">
                  ${redemption.state === 'approved' ? 'æ‰¿èªæ¸ˆã¿' : 'å´ä¸‹'}
                </span>
              `}
            </div>
          </div>
        `;
      }).join('');

      updatePendingCount();
    }

    function formatTimeAgo(dateString) {
      const now = new Date();
      const date = new Date(dateString);
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) return 'ãŸã£ãŸä»Š';
      if (diffMins < 60) return `${diffMins}åˆ†å‰`;
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}æ™‚é–“å‰`;
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays}æ—¥å‰`;
    }

    function filterRedemptions(filter) {
      currentFilter = filter;

      let filtered = redemptions;

      if (filter === 'pending') {
        filtered = filtered.filter(r => r.state === 'pending');
      } else if (filter === 'approved') {
        filtered = filtered.filter(r => r.state === 'approved');
      } else if (filter === 'rejected') {
        filtered = filtered.filter(r => r.state === 'rejected');
      }

      renderRedemptions(filtered);
    }

    function approveRedemption(redemptionId) {
      const index = redemptions.findIndex(r => r.id === redemptionId);
      if (index === -1) return;

      showLoading();

      setTimeout(() => {
        redemptions[index].state = 'approved';
        saveToStorage('redemptions', redemptions);

        hideLoading();
        showToast('ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚', 'success');

        filterRedemptions(currentFilter);
      }, 800);
    }

    function openRejectModal(redemptionId) {
      rejectingId = redemptionId;
      openModal('rejectModal');
    }

    function submitReject() {
      const reason = document.getElementById('rejectReason').value;
      const index = redemptions.findIndex(r => r.id === rejectingId);

      if (index === -1) return;

      showLoading();

      setTimeout(() => {
        redemptions[index].state = 'rejected';
        redemptions[index].rejectReason = reason;
        saveToStorage('redemptions', redemptions);

        hideLoading();
        closeModal('rejectModal');
        showToast('ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ã‚’å´ä¸‹ã—ã¾ã—ãŸ', 'info');

        filterRedemptions(currentFilter);

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('rejectReason').value = '';
      }, 800);
    }

    function updatePendingCount() {
      const pendingCount = redemptions.filter(r => r.state === 'pending').length;
      document.getElementById('pendingCount').textContent = pendingCount;
    }

    // åˆæœŸè¡¨ç¤º
    filterRedemptions('pending');

    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
    setInterval(() => {
      // æ–°ã—ã„æ‰¿èªå¾…ã¡ã‚’æ™‚ã€…è¿½åŠ ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
      if (Math.random() > 0.95) {
        const newRedemption = {
          id: Date.now(),
          cardName: 'ã‚µãƒ³ãƒ—ãƒ«ã‚«ãƒ¼ãƒ‰',
          cardRarity: 'N',
          viewerName: 'è¦–è´è€…' + Math.floor(Math.random() * 100),
          viewerMessage: Math.random() > 0.5 ? 'ã„ã¤ã‚‚è¦‹ã¦ã¾ã™ï¼' : null,
          state: 'pending',
          createdAt: new Date().toISOString()
        };

        redemptions.push(newRedemption);
        saveToStorage('redemptions', redemptions);

        if (currentFilter === 'pending' || currentFilter === 'all') {
          filterRedemptions(currentFilter);
        } else {
          updatePendingCount();
        }
      }
    }, 10000); // 10ç§’ã”ã¨
  </script>
</body>
</html>
